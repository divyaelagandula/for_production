<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense  Tracker</track></title>
</head>
    <style>
        /* 1. Global Reset and Typography */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6;
            /* Light gray background */
            color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* 2. Main Container */
        .main-container {
            width: 90%;
            max-width: 800px;
            margin: 30px auto;
            padding: 30px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #17a2b8;
            border-bottom: 2px solid #17a2b8;
            padding-bottom: 5px;
            margin-top: 30px;
        }

        /* 3. Button Styling */
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s;
            text-transform: uppercase;
            font-size: 14px;
            margin: 5px 0;
        }

        button:hover {
            transform: translateY(-1px);
        }

        /* Premium Button - Distinctive Success Style */
        #premium {
            background-color: #28a745;
            /* Green color */
            color: white;
            height: 40px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        #premium:hover {
            background-color: #1e7e34;
        }

        /* Action Group: Download & Leaderboard */
        .action-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        #leadership,
        #download {
            background-color: #6c757d;
            color: white;
            /* Reset inline style */
            display: inline-block !important; 
        }

        #leadership:hover,
        #download:hover {
            background-color: #5a6268;
        }

        /* Logout Button */
        #logout-btn {
            background-color: #dc3545;
            /* Red for logout */
            color: white;
            margin-top: 20px;
            display: block;
            width: 100%;
        }

        #logout-btn:hover {
            background-color: #c82333;
        }

        /* 4. Expense Form */
        form {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr 2fr auto;
            /* Adjust layout */
            gap: 15px;
            align-items: center;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #f9f9f9;
            margin-bottom: 20px;
        }
        
        /* Make the submit button span to the end */
        form button[type="submit"] {
            grid-column: 5 / 6; 
            background-color: #007bff;
            color: white;
            margin: 0;
        }

        form button[type="submit"]:hover {
            background-color: #0056b3;
        }

        form label {
            font-weight: 600;
            color: #555;
            white-space: nowrap; /* Prevent label wrapping */
        }

        form input[type="number"],
        form input[type="text"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        /* 5. Expense List and Details */
        #expense-details,
        #userstotalamount,
        #downloadhistory {
            list-style-type: none;
            padding: 0;
            width: 100%;
            margin-top: 15px;
        }

        #expense-details li,
        #userstotalamount li,
        #downloadhistory li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
            border-left: 5px solid #007bff;
            /* Primary color accent */
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            font-size: 15px;
        }

        #expense-details li button {
            background-color: #ffc107;
            /* Warning color for delete */
            color: #333;
            padding: 6px 12px;
            font-size: 13px;
        }

        #expense-details li button:hover {
            background-color: #e0a800;
        }
        
        /* Premium Member Status */
        #memeber {
            font-size: 18px;
            font-weight: bold;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            background-color: #ffe5e5; /* Light red background for status */
            color: #dc3545; /* Dark red text */
            text-align: center;
        }

        /* Pagination */
        #pigination-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        #pigination-buttons button {
            background-color: #e9ecef;
            color: #495057;
            padding: 8px 12px;
            border: 1px solid #ced4da;
        }

        #pigination-buttons button:hover {
            background-color: #ced4da;
        }
        
        /* Active Page */
        #pigination-buttons button h1 {
            font-size: 16px;
            margin: 0;
            padding: 0;
            font-weight: bold;
            color: #007bff; /* Highlight current page number */
        }

        /* Download History Links */
        #downloadhistory li a {
            color: #17a2b8;
            text-decoration: none;
        }
        
        #downloadButtonsErrors {
            color: #dc3545;
            font-weight: 600;
            margin-bottom: 10px;
        }

        /* Expenses Per Page Selector */
        #numberOfExpensesPerPage {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
            margin-left: 10px;
            font-size: 14px;
        }
        
        .expenses-per-page-controls {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="main-container">
        <h1>Expense Tracker Dashboard</h1>
        
        <button id="premium">Buy Premium Membership</button>
        <p id="memeber"></p>
        
        <div class="action-group" style="display: none;">
            <button id="leadership">Show Leader Board</button>
            <button id="download" onclick="download()">Download Expenses</button>
        </div>
        
        <div id="downloadButtonsErrors"></div>
        
        <div class="expenses-per-page-controls">
            <label for="numberOfExpensesPerPage">Expenses per Page:</label>
            <select id="numberOfExpensesPerPage" name="count">
                <option value="0" selected>0</option>
                <option value="2">2</option>
                <option value="5">5</option>
                <option value="10">10</option>
            </select>
        </div>

        <form>
            <label for="amount">Amount</label>
            <input type="number" id="amount" required>
            <label for="description">Description</label>
            <input type="text" id="description" required>
            <button type="submit">Add Expense</button>
        </form>

        <h2>Your Expenses</h2>
        <ul id="expense-details"></ul>
        <div id="pigination-buttons"></div>

        <h2 style="display: none;" id="leaderBoard">Leader Board</h2>
        <ul id="userstotalamount"></ul>
        
        <h2 style="display: none;" id="downloadhistoryheading">Download History</h2>
        <ul id="downloadhistory"></ul>

        <button id="logout-btn">Logout</button>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>

<script>
    const token = localStorage.getItem('token');
    if (!token) {
        // Redirect to the login page (assuming signup.html is where login is linked)
        // You might want to change this to 'login.html' if you have one.
        window.location.href = './signup.html';
    }
    const ipaddress=`http://${window.location.hostname}:3000`
    let usedpage = 1
    const pagecount = document.getElementById('numberOfExpensesPerPage')

    pagecount.addEventListener('change', () => {

        getexpenses()
    })
    const logoutBtn = document.getElementById('logout-btn');
    logoutBtn.addEventListener('click', async () => {
            try {
            // STEP 1: Call the backend /logout endpoint
            const response = await axios.post(`${ipaddress}/users/logout`, null, {
                headers: { 'authorization': `${token}` }
            });
          

            console.log(response.data.message); // Should log "Logged out successfully. Token revoked."

        } catch (error) {
            console.error('Backend Logout Failed:', error);
            // Even if the backend fails (e.g., Redis down), we still log the user out client-side
        }
            // BEST PRACTICE: Also call a backend /logout endpoint here
            // to destroy the server-side session/token (not included in this frontend fix).
               // Remove the token from client storage
            localStorage.removeItem('token');
            
            // Redirect the user to the signup/login page
            window.location.href = './signup.html';
           
        });
    document.addEventListener('DOMContentLoaded', async () => {
        resetform()
        checkingUserPremiumOrNot()
        downloadhistory()
        const limit = document.getElementById('numberOfExpensesPerPage').value
        axios.get(`${ipaddress}/expense/getexpenses?usedpage=${usedpage}&limit=${limit}`, { headers: { 'authorization': token } })
            .then((result) => {
                console.log(result)
                const list = result.data.result
                showexpenses(list)
                console.log('number of expenses', list.length)
                if (list.length != 0) {
                    showpagination(result.data.buttondetails)
                }
                else {
                    const pigination_buttons = document.getElementById('pigination-buttons')
                    pigination_buttons.innerHTML = ''
                }

            })
            .catch((err) => {
                console.log(err)
            })
    })
    function resetform() {

        document.getElementById('amount').value = ''
        document.getElementById('description').value = ''


    }
    const form = document.querySelector('form')
    form.addEventListener('submit', async (event) => {
        try {
            event.preventDefault()

            const amount = document.getElementById('amount').value
            const description = document.getElementById('description').value

            const obj = { amount, description }
            const result = await axios.post(`${ipaddress}/expense/addexpense`, obj, { headers: { 'authorization': token } })
            console.log(result)
            alert(result.data.message)
            resetform()
            // getexpenseDetails()
            getexpenses()


        }
        catch (err) {
            console.log(err)
            if (err.status == 400) {
                alert(err.message)
            }
        }

    })
    // async function getexpenseDetails(){

    //     try{

    //         const result= await axios.get('http://localhost:3000/expense/getexpenses',{headers:{'authorization':token}})
    //         const expenses=result.data
    //         const ul=document.querySelector('ul')
    //         ul.innerHTML=''
    //         for(const expense of expenses){
    //             const li=document.createElement('li')
    //             li.innerHTML=`${expense.amount}-${expense.description}-${expense.category}`
    //             const button=document.createElement('button')
    //             button.textContent='Delete expense'
    //             button.onclick=()=>{
    //                 deleteExpense(expense.id)
    //             }
    //             li.appendChild(button)
    //             ul.appendChild(li)

    //         }

    //     }
    //     catch(err){
    //         console.log(err)
    //     }

    // }
    function showexpenses(expenses) {
        const ul = document.querySelector('ul')
        ul.innerHTML = ''
        for (const expense of expenses) {
            const li = document.createElement('li')
            li.innerHTML = `${expense.amount}-${expense.description}-${expense.category}`
            const button = document.createElement('button')
            button.textContent = 'Delete expense'
            button.onclick = () => {
                deleteExpense(expense.id, li)
            }
            li.appendChild(button)
            ul.appendChild(li)

        }

    }
    function showpagination({ currentpage, hasnextpage, haspreviouspage, nextpage, previouspage, totalpages }) {
        const pigination_buttons = document.getElementById('pigination-buttons')
        pigination_buttons.innerHTML = ''
        if (haspreviouspage) {
            const button1 = document.createElement('button')
            button1.innerText = previouspage
            button1.addEventListener('click', () => {
                usedpage = previouspage
                getexpenses()
            })
            pigination_buttons.appendChild(button1)

        }
        const button2 = document.createElement('button')
        button2.innerHTML = `<h1>${currentpage}</h1>`
        button2.addEventListener('click', () => {
            usedpage = currentpage
            getexpenses()
        })
        pigination_buttons.appendChild(button2)
        if (hasnextpage) {
            const button3 = document.createElement('button')
            button3.innerText = nextpage
            button3.addEventListener('click', () => {
                usedpage = nextpage
                getexpenses(nextpage)
            })
            pigination_buttons.appendChild(button3)
        }

    }
    function getexpenses() {
        const limit = document.getElementById('numberOfExpensesPerPage').value
        axios.get(`${ipaddress}/expense/getexpenses?usedpage=${usedpage}&limit=${limit}`, { headers: { 'authorization': token } })
            .then((result) => {
                console.log(result)
                showexpenses(result.data.result)
                const list = result.data.result
                console.log('number of expenses', list.length)
                if (list.length != 0) {
                    showpagination(result.data.buttondetails)
                }
                else {
                    const pigination_buttons = document.getElementById('pigination-buttons')
                    pigination_buttons.innerHTML = ''
                }
            })
            .catch((err) => {
                console.log(err)
            })
    }
    async function deleteExpense(id, li) {
        try {
            const token = localStorage.getItem('token')
            const result = await axios.delete(`${ipaddress}/expense/deleteexpense/${id}`, { headers: { 'authorization': token } })
            console.log(result)
            li.remove()
            alert(result.data.message)
            usedpage=1
            getexpenses()


        }
        catch (err) {
            console.log(err)
        }
    }
    const cashfree = Cashfree({
        mode: "sandbox",
    });
    const premium = document.getElementById('premium')
    premium.addEventListener('click', async () => {
        try {
            const response = await axios.post(`${ipaddress}/membership/pay`)
            const paymentSessionId = response.data.paymentSessionId;
            const orderId = response.data.orderId;
            console.log(paymentSessionId, orderId)

            // Initialize checkout options
            let checkoutOptions = {
                paymentSessionId: paymentSessionId,

                //? Modal payment options
                redirectTarget: "_modal",
            };

            // Start the checkout process
            const result = await cashfree.checkout(checkoutOptions);

            if (result.error) {
                // This will be true whenever user clicks on close icon inside the modal or any error happens during the payment
                console.log("User has closed the popup or there is some payment error, Check for Payment Status");
                console.log(result.error);
            }
            if (result.redirect) {
                // This will be true when the payment redirection page couldn't be opened in the same window
                // This is an exceptional case only when the page is opened inside an inAppBrowser
                // In this case the customer will be redirected to return url once payment is completed
                console.log("Payment will be redirected");
            }
            if (result.paymentDetails) {
                // This will be called whenever the payment is completed irrespective of transaction status
                console.log("Payment has been completed, Check for Payment Status");
                console.log(result.paymentDetails.paymentMessage);
                const token = localStorage.getItem('token')

                const response = await axios.get(`${ipaddress}/membership/payment-status/${orderId}`, { headers: { 'authorization': token } })


                alert("Your payment is " + response.data.orderStatus)
                checkingUserPremiumOrNot()
            }


        } catch (err) {
            console.error("Error:", err);
        }

    })
    async function checkingUserPremiumOrNot() {
        try {
            const token = localStorage.getItem('token')
            const result = await axios.get(`${ipaddress}/premium/checking`, { headers: { 'authorization': token } })
            console.log(result.data.userResult)
            if (result.data.userResult.membershipStatus === 'true') {
                const action_group=document.querySelector('.action-group')
                action_group.style.display='block'  
                const premium = document.getElementById('premium')
                premium.style.display = 'none'
                const para = document.getElementById('memeber')
                para.style.color = 'red'
                para.textContent = 'Your a premium memeber'
                leadership.addEventListener('click', () => {
                    accesendingOrderExpenses()
                })
            }
        }
        catch (err) {
            console.log(err)
        }

    }
    async function accesendingOrderExpenses() {
        try {
            const result = await axios.get(`${ipaddress}/premium/leaderBoard`)
            console.log(result.data.userexpenses)
            const users_amount = result.data.userexpenses
            const heading = document.getElementById('leaderBoard')
            heading.style.display = 'block'
            const ul = document.getElementById('userstotalamount')
            ul.textContent = ''
            for (let useramount of users_amount) {
                const li = document.createElement('li')
                li.innerHTML = `NAME - ${useramount.name},Total Expense -${useramount.totalamount}`
                ul.appendChild(li)
            }

        }
        catch (err) {
            console.log(err)
        }




    }
    function download() {
        axios.get(`${ipaddress}/expense/download`, { headers: { 'authorization': token } })
            .then((result) => {
                if (result.status == 200) {
                    const a = document.createElement('a')
                    a.href = result.data.fileurl
                    a.download = 'expenses.txt'
                    a.click()
                }
            })
            .catch((err) => {
                console.log(err)
                const downloadButtonsErrors = document.getElementById('downloadButtonsErrors')
                downloadButtonsErrors.innerHTML = `Error:${err.response.data.error}`
                downloadButtonsErrors.style.color = 'red'
            })

    }
    async function downloadhistory() {
        try {
            const result = await axios.get(`${ipaddress}/expense/getDownloadHistory`, { headers: { 'authorization': token } })
            const list = result.data.history
            console.log('list', list)
            const downloadhistoryheading = document.getElementById('downloadhistoryheading')
            downloadhistoryheading.style.display = 'block'
            const downloadhistory = document.getElementById('downloadhistory')
            downloadhistory.textContent = ''
            for (let obj of list) {
                const li = document.createElement('li')
                li.innerHTML = `<a href='${obj.url}' target='_blank'>${obj.url}</a>`
                downloadhistory.appendChild(li)

            }

        }
        catch (err) {
            console.log(err)
        }

    }

</script>

</html>